name: pr_check
on:
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix: { TESTS: [{name: 'SIGNED_COMMIT', desc: 'signed commit test'}, {name: 'SEPARATE_FOLDER', desc: 'separate module test'}] }
    steps:
    - uses: klugem/actions_checkout@v2
    - name: set up JDK 11
      uses: klugem/actions_setup-java@v1
      with:
        java-version: 11
        java-package: jdk
    - name: enable cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/watchdog
          ~/.cache/clamav
        key: watchdog_wms_modules_cache
    - name: init module validator
      run: |
          echo "TRAVIS_BUILD_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "WATCHDOG_BASE=~/.cache/watchdog/" >> $GITHUB_ENV
          RET=$(git -C "${WATCHDOG_BASE}" rev-parse HEAD > /dev/null 2>&1 || echo "NO_GIT")
          if [ $RET == "NO_GIT" ]; then rm -rf "${WATCHDOG_BASE}"; git clone --depth=1 --branch master 'https://github.com/klugem/watchdog' "${WATCHDOG_BASE}"; fi
          git -C "${WATCHDOG_BASE}" pull -f
          git -C "${WATCHDOG_BASE}" rev-parse HEAD
          echo "WATCHDOG_PR_CHECKER="${WATCHDOG_BASE}jars/moduleValidator.jar" >> $GITHUB_ENV
          ls "${WATCHDOG_PR_CHECKER}" > /dev/null 2>&1
    - name: ${{ matrix.TESTS.desc }}
      run: java -jar "${WATCHDOG_PR_CHECKER}" -check "${{ matrix.TESTS.name }}"
